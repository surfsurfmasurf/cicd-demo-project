name: CI/CD íŒŒì´í”„ë¼ì¸

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# ì‹¤í–‰í•  ì‘ì—…ë“¤
jobs:
  # Job 1: í…ŒìŠ¤íŠ¸
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
    
    - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm test
    
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: coverage/

  # Job 2: ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í†µê³¼ í›„)
  build:
    name: ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: test  # í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
    
    - name: âœ… ë¹Œë“œ ì™„ë£Œ
      run: echo "ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

  # Job 3: ë°°í¬ ì‹œë®¬ë ˆì´ì…˜ (main/master ë¸Œëœì¹˜ë§Œ)
  deploy:
    name: ë°°í¬
    runs-on: ubuntu-latest
    needs: [test, build]  # í…ŒìŠ¤íŠ¸ì™€ ë¹Œë“œê°€ ëª¨ë‘ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸš€ ë°°í¬ ì‹œì‘
      run: |
        echo "=========================================="
        echo "ğŸš€ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        echo "=========================================="
        echo "ë¸Œëœì¹˜: ${{ github.ref }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        echo "ì‘ì„±ì: ${{ github.actor }}"
        echo "=========================================="
        echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "=========================================="
    
    - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: echo "::notice::ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰"
